<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Grant Adams">

<title>Delta correction and gam smooth</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="ROMS index generation_files/libs/clipboard/clipboard.min.js"></script>
<script src="ROMS index generation_files/libs/quarto-html/quarto.js"></script>
<script src="ROMS index generation_files/libs/quarto-html/popper.min.js"></script>
<script src="ROMS index generation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ROMS index generation_files/libs/quarto-html/anchor.min.js"></script>
<link href="ROMS index generation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ROMS index generation_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ROMS index generation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ROMS index generation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ROMS index generation_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Delta correction and gam smooth</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Grant Adams </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This quarto doc overviews the process for making environmental indices from the ROMS NEP data including: data overview, index creation, and delta correction. We don’t proved generic functions because each GOA-CLIM modeler may have indices specific to a particular spatial and temporal domain. We therefore provide an example rubric that folks can copy and derive their desired indices.</p>
</section>
<section id="data-overview" class="level2">
<h2 class="anchored" data-anchor-id="data-overview">Data overview</h2>
<p>Projections of environmental variables biomass are derived from a downscaled Intergovernmental Panel on Climate Change (IPCC) projection model from the coupled model intercomparison project (CMIP): GFDL-ESM2M. The IPCC projection model was downscaled using the North East Pacific (NEP) Regional Ocean Modeling System (ROMS) developed for the Gulf of Alaska.</p>
<p>ROMS simulations are referred to as the following:</p>
<ul>
<li><p><strong>hindcast</strong>: representing the final years of the spinup forced with observed oceanographic conditions to better represent historical conditions (1990 to 2020),</p></li>
<li><p><strong>projection</strong>: GFDL-ESM2M downscaled projection (2015 to 2099)</p></li>
<li><p><strong>historical</strong>: representing model spinup (1980 to 2014).</p></li>
</ul>
<p>Variables from ROMS simulations averaged for each layer and grid cell on a monthly time scale were averaged or summed across the following vertical distributions:</p>
<ul>
<li><p>Surface (from 0 to 10 m depth)</p></li>
<li><p>Bottom (from bottom to 10 m from bottom)</p></li>
<li><p>Midwater (from 10 m depth to 10 m from bottom)</p></li>
</ul>
<p>The averaged for each NMFS management area to the 300 m or 1,000 m isobath (areas are calculated from <code>st_area</code> in the <code>sf</code> package):</p>
<ul>
<li><p>610 area is 57225003746 <span class="math inline">\(m^2\)</span> for 300 m isobath and 63986698621 <span class="math inline">\(m^2\)</span> for 1,000 m isobath</p></li>
<li><p>620 area is 62597059226 <span class="math inline">\(m^2\)</span> for 300 m isobath and 69583703140 <span class="math inline">\(m^2\)</span> for 1,000 m isobath</p></li>
<li><p>630 area is 98582220025 <span class="math inline">\(m^2\)</span> for 300 m isobath and 105918077937 <span class="math inline">\(m^2\)</span> for 1,000 m isobath</p></li>
<li><p>640 area is 32560976631 <span class="math inline">\(m^2\)</span> for 300 m isobath and 37270389681 <span class="math inline">\(m^2\)</span> for 1,000 m isobath</p></li>
<li><p>650 area is 36726651409 <span class="math inline">\(m^2\)</span> for 300 m isobath and 43952466109 <span class="math inline">\(m^2\)</span> for 1,000 m isobath</p></li>
<li><p>All areas</p></li>
</ul>
<p>The “raw” monthly data are located in the <strong>“/Data/NEP_10k_revised_indices”</strong> folder with the 300 or 1000 at the end of the file name indicating the isobath they are averaged to. They represent the monthly indices either averaged across each depth and spatial domain (“nep_avg_…”) or summed across each depth domain and then averaged across the spatial domain (“nep_sum_…”). The “/Data/NEP_10k_indices” folder are the old indices that had errors in the time-series fixed by Al.</p>
</section>
<section id="index-derivation" class="level2">
<h2 class="anchored" data-anchor-id="index-derivation">Index derivation</h2>
<p>Environmental indices can be derived for each modelers following their specific needs. We don’t develop all indices here as individual modeler’s needs may vary. But, indices integrated across each spatial NMFS management area should be area weighted using the following areas.</p>
</section>
<section id="delta-correction-overview" class="level2">
<h2 class="anchored" data-anchor-id="delta-correction-overview">Delta correction overview</h2>
<p>Delta correction is done to correct for shifts in the time series between the hindcast and projection. For normally distributed variables (*Y*):</p>
<p><span class="math display">\[
X^{proj'}_t=\bar{X}^{hind}_{\bar{T}}+
\left(\frac{\sigma^{hind}_{\bar{T}}}{\sigma^{hist}_{\bar{T}}} *
\left(X^{proj}_t-\bar{X}_{\bar{T}}^{hist} \right)\right)
\]</span></p>
<p>where <span class="math inline">\(X^{proj'}_t\)</span> is the bias corrected projection index in time-step $t$, <span class="math inline">\(\bar{X}^{hind}_{\bar{T}}\)</span> is the average index value from the hindcast during reference period <span class="math inline">\(T\)</span>, <span class="math inline">\(\sigma^{hind}_{\bar{T}}\)</span> is the standard deviation of the index from the hindcast during the reference period, <span class="math inline">\(\sigma^{hist}_{\bar{T}}\)</span> is the standard deviation of the index from the historical run during the reference period, <span class="math inline">\(X^{proj}_t\)</span> is the non bias-corrected projection index, <span class="math inline">\(\bar{X}_{\bar{T}}^{hist}\)</span> is the average value from historical run during the reference period.</p>
<p>For log-normally distributed variables the formula can be adjusted as follows:</p>
<p><span class="math display">\[
X^{proj'}_t=\exp\left(\bar{logX}^{hind}_{\bar{T}}+
\left(\frac{\sigma^{hind}_{\bar{T}}}{\sigma^{hist}_{\bar{T}}} *
\left(logX^{proj}_t-\bar{logX}_{\bar{T}}^{hist} \right)\right)\right)
\]</span></p>
<p>where <span class="math inline">\(T\)</span>, <span class="math inline">\(\sigma^{hind}_{\bar{T}}\)</span> is the standard deviation of the log index from the hindcast during the reference period, <span class="math inline">\(\sigma^{hist}_{\bar{T}}\)</span> is the standard deviation of the log index from the historical run during the reference period.</p>
<p>Because the smallest time step in month, the mean and variance terms should be calculated as follows:</p>
<ul>
<li>Monthly indices: time-step <span class="math inline">\(t\)</span> should be year <span class="math inline">\(y\)</span> and month <span class="math inline">\(m\)</span> (e.g.&nbsp;<span class="math inline">\(t=y,m\)</span>)</li>
</ul>
<p>Users can decide to apply a delta correction method that does not use the ratio between the standard deviations as scaling factor. Scaling by the standard deviation may result in artefacts being introduced, for example if one of the <span class="math inline">\(\sigma\)</span> values is particularly high. This should not happen much at the spatial and temporal resolution used here, but it has been a known issue in Atlantis (which uses daily time steps and a small spatial scale, resulting in fewer ROMS points per calculation) and in some ACLIM applications. The default is <code>use_sd = TRUE</code>.</p>
<p>When doing the delta correction, users can decide whether they want the end product to be a time series that consists of the bias-corrected historical run and projection, or historical run, hindcast, and projection. The second option splices the hindcast (which incorporates observations) into the full bias-corrected time series. Analysts that are interested in exploring the effects of recent climate events in the GOA (e.g., the heat wave) may want to use <code>include_hindcast = TRUE</code>. If projections are the focus, this becomes less important.</p>
</section>
<section id="variables-in-roms-nep" class="level2">
<h2 class="anchored" data-anchor-id="variables-in-roms-nep">Variables in ROMS NEP</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>nep_vars <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_variable_names.csv"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(nep_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Units</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">NEP.name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Ammonium</td>
<td style="text-align: left;">mmol N m^-3</td>
<td style="text-align: left;">NH4</td>
</tr>
<tr class="even">
<td style="text-align: left;">detritus concentration</td>
<td style="text-align: left;">mg C m^-3</td>
<td style="text-align: left;">Det</td>
</tr>
<tr class="odd">
<td style="text-align: left;">euphausiid concentration</td>
<td style="text-align: left;">mg C m^-3</td>
<td style="text-align: left;">Eup</td>
</tr>
<tr class="even">
<td style="text-align: left;">euphausiid net production rate</td>
<td style="text-align: left;">mg C m^-3 d^-1</td>
<td style="text-align: left;">prod_Eup</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Iron concentration</td>
<td style="text-align: left;">micromol Fe m-3</td>
<td style="text-align: left;">Iron</td>
</tr>
<tr class="even">
<td style="text-align: left;">Large copepod concentration</td>
<td style="text-align: left;">mg C m^-3</td>
<td style="text-align: left;">NCa</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Large copepod production rate</td>
<td style="text-align: left;">mg C m^-3 d^-1</td>
<td style="text-align: left;">prod_NCa</td>
</tr>
<tr class="even">
<td style="text-align: left;">Large microzooplankton concentration</td>
<td style="text-align: left;">mg C m^-3</td>
<td style="text-align: left;">MZL</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Large microzooplankton production rate</td>
<td style="text-align: left;">mg C m^-3 d^-1</td>
<td style="text-align: left;">prod_MZL</td>
</tr>
<tr class="even">
<td style="text-align: left;">Large phytoplankton concentration</td>
<td style="text-align: left;">mg C m^-3</td>
<td style="text-align: left;">PhL</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Large phytoplankton production rate</td>
<td style="text-align: left;">mg C m^-3 d^-1</td>
<td style="text-align: left;">prod_PhL</td>
</tr>
<tr class="even">
<td style="text-align: left;">Time-averaged f ratio for large phytoplankton</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">frat_PhL</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Nitrate</td>
<td style="text-align: left;">mmol N m^-3</td>
<td style="text-align: left;">NO3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Salinity</td>
<td style="text-align: left;">PSU</td>
<td style="text-align: left;">salt</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Small copepod concentration</td>
<td style="text-align: left;">mg C m^-3</td>
<td style="text-align: left;">Cop</td>
</tr>
<tr class="even">
<td style="text-align: left;">Small copepod net production rate</td>
<td style="text-align: left;">mg C m^-3 d^-1</td>
<td style="text-align: left;">prod_Cop</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Small microzooplankton concentration</td>
<td style="text-align: left;">mg C m^-3</td>
<td style="text-align: left;">MZS</td>
</tr>
<tr class="even">
<td style="text-align: left;">Small microzooplankton production rate</td>
<td style="text-align: left;">mg C m^-3 d^-1</td>
<td style="text-align: left;">prod_MZS</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Small phytoplankton concentration</td>
<td style="text-align: left;">mg C m^-3</td>
<td style="text-align: left;">PhS</td>
</tr>
<tr class="even">
<td style="text-align: left;">Small phytoplankton production rate</td>
<td style="text-align: left;">mg C m^-3 d^-1</td>
<td style="text-align: left;">prod_PhS</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Time-averaged f ratio for small phytoplankton</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">frat_PhS</td>
</tr>
<tr class="even">
<td style="text-align: left;">Temperature</td>
<td style="text-align: left;">Celsius</td>
<td style="text-align: left;">temp</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="developing-an-index-in-r" class="level2">
<h2 class="anchored" data-anchor-id="developing-an-index-in-r">Developing an index in R</h2>
<p>Load packages and functions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("pacman")</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(mgcv, dplyr, lubridate, ggplot2, tidyr)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"R/Delta_correction.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Load data (averaged to 300 m isobath</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data averaged across depth and strata</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>nep_hind <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_revised_indices/nep_avg_hind_300.csv"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>nep_hind<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"hindcast"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>nep_hist <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_revised_indices/nep_avg_wb_hist_300.csv"</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>nep_hist<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"historical"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>nep_ssp126 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_revised_indices/nep_avg_wb_ssp126_300.csv"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>nep_ssp126<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"ssp126"</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>nep_585 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_revised_indices/nep_avg_wb_ssp585_300.csv"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>nep_585<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"ssp585"</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine in list</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>roms_avg_data <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">list</span>(nep_hind, nep_hist, nep_ssp126, nep_585))</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Add time and date information</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>roms_avg_data <span class="ot">&lt;-</span> roms_avg_data <span class="sc">%&gt;%</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> lubridate<span class="sc">::</span><span class="fu">as_date</span>(date),</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(date),</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> lubridate<span class="sc">::</span><span class="fu">year</span>(date))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Example indices 1:</strong> monthly index of sea surface temperature across all spatial strata</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run bias correction for all variables </span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - rbinds bias-corrected projection to historical run</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - SSP126</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>ssp126_biascorrected <span class="ot">&lt;-</span> <span class="fu">delta_correction</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">hindcast =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"hindcast"</span>),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">historical =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"historical"</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">projection =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"ssp126"</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ref_yrs =</span> <span class="dv">1990</span><span class="sc">:</span><span class="dv">2014</span>, <span class="co"># Overlap years for historical and hindcast ROMS</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">lognormal =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">use_sd =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_hindcast =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># - SSP585</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>ssp585_biascorrected <span class="ot">&lt;-</span> <span class="fu">delta_correction</span>(</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">hindcast =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"hindcast"</span>),</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">historical =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"historical"</span>),</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">projection =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"ssp585"</span>),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">ref_yrs =</span> <span class="dv">1990</span><span class="sc">:</span><span class="dv">2014</span>, <span class="co"># Overlap years for historical and hindcast ROMS</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">lognormal =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">use_sd =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_hindcast =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract variable of interest</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>goa_SST_ssp126 <span class="ot">&lt;-</span> ssp126_biascorrected <span class="sc">%&gt;%</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(varname <span class="sc">==</span> <span class="st">"temp"</span> <span class="sc">&amp;</span> depthclass <span class="sc">==</span> <span class="st">"Surface"</span> <span class="sc">&amp;</span> NMFS_AREA <span class="sc">==</span> <span class="st">"All"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simulation =</span> <span class="st">"ssp126"</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>goa_SST_ssp585 <span class="ot">&lt;-</span> ssp585_biascorrected <span class="sc">%&gt;%</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(varname <span class="sc">==</span> <span class="st">"temp"</span> <span class="sc">&amp;</span> depthclass <span class="sc">==</span> <span class="st">"Surface"</span> <span class="sc">&amp;</span> NMFS_AREA <span class="sc">==</span> <span class="st">"All"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simulation =</span> <span class="st">"ssp585"</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">rbind</span>(goa_SST_ssp126, goa_SST_ssp585), <span class="fu">aes</span>(date, value_dc)) <span class="sc">+</span> </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>simulation) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"SST (C)"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Year-Month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ROMS-index-generation_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Example indices 2:</strong> seasonal sea surface temperature across all spatial strata</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Take monthlies and average from SSP126</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>seasonal_sst_ssp126 <span class="ot">&lt;-</span> goa_SST_ssp126 <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">season =</span> <span class="fu">case_when</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>) <span class="sc">~</span> <span class="st">"spring"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">11</span>,<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">2</span>) <span class="sc">~</span> <span class="st">"winter"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>) <span class="sc">~</span> <span class="st">"summer"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">10</span>) <span class="sc">~</span> <span class="st">"fall"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(NMFS_AREA, simulation, varname, year, season) <span class="sc">%&gt;%</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">value_dc =</span> <span class="fu">mean</span>(value_dc))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(seasonal_sst_ssp126, <span class="fu">aes</span>(year, value_dc, <span class="at">colour =</span> season)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"SST (C)"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Year"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ROMS-index-generation_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Example indices 3:</strong> Monthly sea surface temperature across 610 and 620 for SSP126 and SSP585</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract variables we want</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>goa_SST_ssp126 <span class="ot">&lt;-</span> ssp126_biascorrected <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(varname <span class="sc">==</span> <span class="st">"temp"</span> <span class="sc">&amp;</span> depthclass <span class="sc">==</span> <span class="st">"Surface"</span> <span class="sc">&amp;</span> NMFS_AREA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"610"</span>, <span class="st">"620"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simulation =</span> <span class="st">"ssp126"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">values_from =</span> <span class="fu">c</span>(value_dc, value), <span class="at">names_from =</span> NMFS_AREA) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value_dc_610_620 =</span> (value_dc_610 <span class="sc">*</span> <span class="dv">63986698621</span> <span class="sc">+</span> value_dc_620 <span class="sc">*</span> <span class="dv">69583703140</span>) <span class="sc">/</span> (<span class="dv">63986698621</span> <span class="sc">+</span> <span class="dv">69583703140</span>)) <span class="co"># Take area weighted mean</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>goa_SST_ssp585 <span class="ot">&lt;-</span> ssp585_biascorrected <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(varname <span class="sc">==</span> <span class="st">"temp"</span> <span class="sc">&amp;</span> depthclass <span class="sc">==</span> <span class="st">"Surface"</span> <span class="sc">&amp;</span> NMFS_AREA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"610"</span>, <span class="st">"620"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simulation =</span> <span class="st">"ssp585"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">values_from =</span> <span class="fu">c</span>(value_dc, value), <span class="at">names_from =</span> NMFS_AREA) <span class="sc">%&gt;%</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value_dc_610_620 =</span> (value_dc_610 <span class="sc">*</span> <span class="dv">63986698621</span> <span class="sc">+</span> value_dc_620 <span class="sc">*</span> <span class="dv">69583703140</span>) <span class="sc">/</span> (<span class="dv">63986698621</span> <span class="sc">+</span> <span class="dv">69583703140</span>)) <span class="co"># Take area weighted mean</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>goa_SST_610_620 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(goa_SST_ssp126, goa_SST_ssp585)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(goa_SST_610_620, <span class="fu">aes</span>(year, value_dc_610_620, <span class="at">colour =</span> simulation)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"SST (C)"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Year"</span>) <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>simulation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ROMS-index-generation_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Example index 4:</strong> mean seasonal small copepod biomass spatial strata 610 and 620 up to the 300 m isobath for SSP585 across the water column</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data integrated across depth and strata</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>nep_hind <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_revised_indices/nep_sum_hind_300.csv"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>nep_hind<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"hindcast"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>nep_hist <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_revised_indices/nep_sum_wb_hist_300.csv"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>nep_hist<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"historical"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>nep_ssp126 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_revised_indices/nep_sum_wb_ssp126_300.csv"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>nep_ssp126<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"ssp126"</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>nep_585 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_revised_indices/nep_sum_wb_ssp585_300.csv"</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>nep_585<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"ssp585"</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine in list</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>roms_sum_data <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">list</span>(nep_hind, nep_hist, nep_ssp126, nep_585))</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Add time and date information</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>roms_sum_data <span class="ot">&lt;-</span> roms_sum_data <span class="sc">%&gt;%</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> lubridate<span class="sc">::</span><span class="fu">as_date</span>(date),</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(date),</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> lubridate<span class="sc">::</span><span class="fu">year</span>(date))</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Run bias correction for all variables </span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co"># - rbinds bias-corrected projection to historical run</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co"># - SSP126</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>ssp126_sum_biascorrected <span class="ot">&lt;-</span> <span class="fu">delta_correction</span>(</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">hindcast =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"hindcast"</span>),</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">historical =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"historical"</span>),</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">projection =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"ssp126"</span>),</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">ref_yrs =</span> <span class="dv">1990</span><span class="sc">:</span><span class="dv">2014</span>, <span class="co"># Overlap years for historical and hindcast ROMS</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">lognormal =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">use_sd =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_hindcast =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="co"># - SSP585</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>ssp585_sum_biascorrected <span class="ot">&lt;-</span> <span class="fu">delta_correction</span>(</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">hindcast =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"hindcast"</span>),</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">historical =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"historical"</span>),</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">projection =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"ssp585"</span>),</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">ref_yrs =</span> <span class="dv">1990</span><span class="sc">:</span><span class="dv">2014</span>, <span class="co"># Overlap years for historical and hindcast ROMS</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">lognormal =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">use_sd =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_hindcast =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract small copepod for desired area</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>goa_cop_ssp585 <span class="ot">&lt;-</span> ssp585_sum_biascorrected <span class="sc">%&gt;%</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(varname <span class="sc">==</span> <span class="st">"Cop"</span> <span class="sc">&amp;</span> depthclass <span class="sc">==</span> <span class="st">"All"</span> <span class="sc">&amp;</span> NMFS_AREA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">610</span>, <span class="dv">620</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simulation =</span> <span class="st">"ssp585"</span>)</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to t C per NMFS area. You may use alternative calculations here</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a><span class="co"># - Units of Cop in the *sum* files are mg C m^-2 of water column</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a><span class="co"># - Area is in m^2</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="co"># - There are 1e-9 tonnes in a mg</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a><span class="co"># - Final units will be t C per NMFS area </span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>goa_cop_ssp585 <span class="ot">&lt;-</span> goa_cop_ssp585 <span class="sc">%&gt;%</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Cop_biom =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>    NMFS_AREA <span class="sc">==</span> <span class="st">"610"</span> <span class="sc">~</span> <span class="dv">63986698621</span> <span class="sc">*</span> value_dc <span class="sc">*</span> <span class="fl">1e-9</span>, <span class="co"># 610 area = 63986698621 m^2</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    NMFS_AREA <span class="sc">==</span> <span class="st">"620"</span> <span class="sc">~</span> <span class="dv">69583703140</span> <span class="sc">*</span> value_dc <span class="sc">*</span> <span class="fl">1e-9</span> <span class="co"># 620 area = 69583703140 m^2</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Take mean fall </span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>goa_cop_ssp585 <span class="ot">&lt;-</span> goa_cop_ssp585 <span class="sc">%&gt;%</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, month) <span class="sc">%&gt;%</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Cop_biom =</span> <span class="fu">sum</span>(Cop_biom)) <span class="sc">%&gt;%</span> <span class="co"># Sum biomass across 610 and 620</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">season =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>) <span class="sc">~</span> <span class="st">"spring"</span>,</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">11</span>,<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">2</span>) <span class="sc">~</span> <span class="st">"winter"</span>,</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>) <span class="sc">~</span> <span class="st">"summer"</span>,</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">10</span>) <span class="sc">~</span> <span class="st">"fall"</span>,</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, season) <span class="sc">%&gt;%</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Cop_biom =</span> <span class="fu">mean</span>(Cop_biom)) <span class="co"># Average across months per season</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(goa_cop_ssp585, <span class="fu">aes</span>(year, Cop_biom, <span class="at">colour =</span> season)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cop biomass (tonnes)"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Year"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ROMS-index-generation_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Example index 5:</strong> annual small copepod production (<span class="math inline">\(t C km^{-2} yr^{-1}\)</span>) per NMFS area, up to the 300 m isobath, for scenario ssp585. This example should yield a production index that could be used in EwE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract small copepod production for desired area</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting from sum file because it already integrates concentrations to have them as "flat" values per area</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>goa_cop_prod_ssp585 <span class="ot">&lt;-</span> ssp585_sum_biascorrected <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(varname <span class="sc">==</span> <span class="st">"prod_Cop"</span> <span class="sc">&amp;</span> depthclass <span class="sc">==</span> <span class="st">"All"</span> <span class="sc">&amp;</span> NMFS_AREA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">610</span>, <span class="dv">620</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simulation =</span> <span class="st">"ssp585"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to t C km^-2 yr^-1 per NMFS area. You may use alternative calculations here</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - Units of prod_Cop are mg C m^-2 d^-1</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># - Area is in m^2. There are 1e+6 m2 in a km2</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># - There are 1e-9 tonnes in a mg</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># - There are ~30 days in a month (approximation, you could get more precise and interpolate monthly values to daily)</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>goa_cop_prod_ssp585_ewe <span class="ot">&lt;-</span> goa_cop_prod_ssp585 <span class="sc">%&gt;%</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(date),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> lubridate<span class="sc">::</span><span class="fu">year</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">monthly_value =</span> value_dc <span class="sc">*</span> <span class="fl">1e-9</span> <span class="sc">*</span> <span class="fl">1e+6</span> <span class="sc">*</span> <span class="dv">30</span>) <span class="sc">%&gt;%</span> <span class="co"># value in t C km-2 mo-1</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(NMFS_AREA, simulation, depthclass, varname, year) <span class="sc">%&gt;%</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">ecopath_value =</span> <span class="fu">sum</span>(monthly_value)) <span class="sc">%&gt;%</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(goa_cop_prod_ssp585_ewe, <span class="fu">aes</span>(year, ecopath_value, <span class="at">colour =</span> NMFS_AREA)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cop production (tonnes C km-2 yr-1)"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Year"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ROMS-index-generation_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>
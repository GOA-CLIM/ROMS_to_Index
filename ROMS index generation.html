<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Grant Adams">

<title>Delta correction and gam smooth</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="ROMS index generation_files/libs/clipboard/clipboard.min.js"></script>
<script src="ROMS index generation_files/libs/quarto-html/quarto.js"></script>
<script src="ROMS index generation_files/libs/quarto-html/popper.min.js"></script>
<script src="ROMS index generation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ROMS index generation_files/libs/quarto-html/anchor.min.js"></script>
<link href="ROMS index generation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ROMS index generation_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ROMS index generation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ROMS index generation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ROMS index generation_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Delta correction and gam smooth</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Grant Adams </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This quarto doc overviews the process for making environmental indices from the ROMS NEP data including: data overview, index creation, and delta correction. We don’t proved generic functions because each GOA-CLIM modeler may have indices specific to a particular spatial and temporal domain. We therefore provide an example rubric that folks can copy and derive their desired indices.</p>
</section>
<section id="data-overview" class="level2">
<h2 class="anchored" data-anchor-id="data-overview">Data overview</h2>
<p>Projections of environmental variables biomass are derived from a downscaled Intergovernmental Panel on Climate Change (IPCC) projection model from the coupled model intercomparison project (CMIP): GFDL-ESM2M. The IPCC projection model was downscaled using the North East Pacific (NEP) Regional Ocean Modeling System (ROMS) developed for the Gulf of Alaska.</p>
<p>ROMS simulations are referred to as the following:</p>
<ul>
<li><p><strong>hindcast</strong>: representing model spinup (2000 to 2020),</p></li>
<li><p><strong>projection</strong>: GFDL-ESM2M downscaled projection (2015 to 2099)</p></li>
<li><p><strong>historical</strong>: representing the final year of the spinup forced with observed oceanographic conditions to better represent historical conditions (1980 to 2014).</p></li>
</ul>
<p>Variables from ROMS simulations averaged for each layer and grid cell on a monthly time scale were averaged or summed across the following vertical distributions:</p>
<ul>
<li><p>Surface (from 0 to 10 m depth)</p></li>
<li><p>Bottom (from bottom to 10 m from bottom)</p></li>
<li><p>Midwater (from 10 m depth to 10 m from bottom)</p></li>
</ul>
<p>The averaged for each NMFS management area to the 1,000 m isobath (areas are calculated from <code>st_area</code> in the <code>sf</code> package):</p>
<ul>
<li><p>610 (area = 63986698621 <span class="math inline">\(m^2\)</span>)</p></li>
<li><p>620 (area = 69583703140 <span class="math inline">\(m^2\)</span>)</p></li>
<li><p>630 (area = 105918077937 <span class="math inline">\(m^2\)</span>)</p></li>
<li><p>640 (area = 37270389681 <span class="math inline">\(m^2\)</span>)</p></li>
<li><p>650 (area = 43952466109 <span class="math inline">\(m^2\)</span>)</p></li>
<li><p>All areas</p></li>
</ul>
<p>The “raw” monthly data are located in the <strong>“/Data/NEP_10k_indices”</strong> folder. They represent the monthly indices either averaged across each depth and spatial domain (“nep_avg_…”) or summed across each depth domain and then averaged across the spatial domain (“nep_sum…”).</p>
</section>
<section id="index-derivation" class="level2">
<h2 class="anchored" data-anchor-id="index-derivation">Index derivation</h2>
<p>Environmental indices can be derived for each modelers following their specific needs. We don’t develop all indices here as individual modeler’s needs may vary. But, indices integrated across each spatial NMFS management area should be area weighted using the following areas.</p>
</section>
<section id="delta-correction-overview" class="level2">
<h2 class="anchored" data-anchor-id="delta-correction-overview">Delta correction overview</h2>
<p>Delta correction is done to correct for shifts in the time series between the hindcast and projection. For normally distributed variables (*Y*):</p>
<p><span class="math display">\[
X^{proj'}_t=\bar{X}^{hind}_{\bar{T}}+
\left(\frac{\sigma^{hind}_{\bar{T}}}{\sigma^{hist}_{\bar{T}}} *
\left(X^{proj}_t-\bar{X}_{\bar{T}}^{hist} \right)\right)
\]</span></p>
<p>where <span class="math inline">\(X^{proj'}_t\)</span> is the bias corrected projection index in time-step $t$, <span class="math inline">\(\bar{X}^{hind}_{\bar{T}}\)</span> is the average index value from the hindcast during reference period <span class="math inline">\(T\)</span>, $</p>
<p>^{hind}_{{T}}$ is the standard deviation of the index from the hindcast during the reference period, <span class="math inline">\(\sigma^{hist}_{\bar{T}}\)</span> is the standard deviation of the index from the historical run during the reference period, <span class="math inline">\(X^{proj}_t\)</span> is the non bias-corrected projection index, <span class="math inline">\(\bar{X}_{\bar{T}}^{hist}\)</span> is the average value from historical run during the reference period.</p>
<p>For log-normally distributed variables the formula can be adjusted as follows:</p>
<p><span class="math display">\[
X^{proj'}_t=\exp\left(\bar{logX}^{hind}_{\bar{T}}+
\left(\frac{\sigma^{hind}_{\bar{T}}}{\sigma^{hist}_{\bar{T}}} *
\left(logX^{proj}_t-\bar{logX}_{\bar{T}}^{hist} \right)\right)\right)
\]</span></p>
<p>where <span class="math inline">\(T\)</span>, $</p>
<p>^{hind}_{{T}}$ is the standard deviation of the log index from the hindcast during the reference period, <span class="math inline">\(\sigma^{hist}_{\bar{T}}\)</span> is the standard deviation of the log indext from the histroical run during the reference period.</p>
<p>Because the smallest time step in month, the mean and variance terms should be calculated as follows:</p>
<ul>
<li>Monthly indices: time-step <span class="math inline">\(t\)</span> should be year <span class="math inline">\(y\)</span> and month <span class="math inline">\(m\)</span> (e.g.&nbsp;<span class="math inline">\(t=y,m\)</span>)</li>
</ul>
</section>
<section id="variables-in-roms-nep" class="level2">
<h2 class="anchored" data-anchor-id="variables-in-roms-nep">Variables in ROMS NEP</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>nep_vars <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_variable_names.csv"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(nep_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table>
 <thead>
  <tr>
   <th style="text-align:left;"> Variable </th>
   <th style="text-align:left;"> Units </th>
   <th style="text-align:left;"> NEP.name </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Ammonium </td>
   <td style="text-align:left;"> mmol N m^-3 </td>
   <td style="text-align:left;"> NH4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> detritus concentration </td>
   <td style="text-align:left;"> mg C m^-3 </td>
   <td style="text-align:left;"> Det </td>
  </tr>
  <tr>
   <td style="text-align:left;"> euphausiid concentration </td>
   <td style="text-align:left;"> mg C m^-3 </td>
   <td style="text-align:left;"> Eup </td>
  </tr>
  <tr>
   <td style="text-align:left;"> euphausiid net production rate </td>
   <td style="text-align:left;"> mg C m^-3 d^-1 </td>
   <td style="text-align:left;"> prod_Eup </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Iron concentration </td>
   <td style="text-align:left;"> micromol Fe m-3 </td>
   <td style="text-align:left;"> Iron </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Large copepod concentration </td>
   <td style="text-align:left;"> mg C m^-3 </td>
   <td style="text-align:left;"> NCa </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Large copepod production rate </td>
   <td style="text-align:left;"> mg C m^-3 d^-1 </td>
   <td style="text-align:left;"> prod_NCa </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Large microzooplankton concentration </td>
   <td style="text-align:left;"> mg C m^-3 </td>
   <td style="text-align:left;"> MZL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Large microzooplankton production rate </td>
   <td style="text-align:left;"> mg C m^-3 d^-1 </td>
   <td style="text-align:left;"> prod_MZL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Large phytoplankton concentration </td>
   <td style="text-align:left;"> mg C m^-3 </td>
   <td style="text-align:left;"> PhL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Large phytoplankton production rate </td>
   <td style="text-align:left;"> mg C m^-3 d^-1 </td>
   <td style="text-align:left;"> prod_PhL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Time-averaged f ratio for large phytoplankton </td>
   <td style="text-align:left;">  </td>
   <td style="text-align:left;"> frat_PhL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Nitrate </td>
   <td style="text-align:left;"> mmol N m^-3 </td>
   <td style="text-align:left;"> NO3 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Salinity </td>
   <td style="text-align:left;"> PSU </td>
   <td style="text-align:left;"> salt </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Small copepod concentration </td>
   <td style="text-align:left;"> mg C m^-3 </td>
   <td style="text-align:left;"> Cop </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Small copepod net production rate </td>
   <td style="text-align:left;"> mg C m^-2 d^-1 </td>
   <td style="text-align:left;"> prod_Cop </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Small microzooplankton concentration </td>
   <td style="text-align:left;"> mg C m^-3 </td>
   <td style="text-align:left;"> MZS </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Small microzooplankton production rate </td>
   <td style="text-align:left;"> mg C m^-3 d^-1 </td>
   <td style="text-align:left;"> prod_MZS </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Small phytoplankton concentration </td>
   <td style="text-align:left;"> mg C m^-3 </td>
   <td style="text-align:left;"> PhS </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Small phytoplankton production rate </td>
   <td style="text-align:left;"> mg C m^-3 d^-1 </td>
   <td style="text-align:left;"> prod_PhS </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Time-averaged f ratio for small phytoplankton </td>
   <td style="text-align:left;">  </td>
   <td style="text-align:left;"> frat_PhS </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Temperature </td>
   <td style="text-align:left;"> Celcius </td>
   <td style="text-align:left;"> temp </td>
  </tr>
</tbody>
</table>

</div>
</div>
</section>
<section id="developing-an-index-in-r" class="level2">
<h2 class="anchored" data-anchor-id="developing-an-index-in-r">Developing an index in R</h2>
<p>Load packages and functions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("pacman")</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(mgcv, dplyr, lubridate, ggplot2, tidyr)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"R/Delta_correction.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Load data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data averaged across depth and strata</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>nep_hind <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_indices/nep_avg_hind.csv"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>nep_hind<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"hindcast"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>nep_hist <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_indices/nep_avg_wb_hist.csv"</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>nep_hist<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"historical"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>nep_ssp126 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_indices/nep_avg_wb_ssp126.csv"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>nep_ssp126<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"ssp126"</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>nep_585 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_indices/nep_avg_wb_ssp585.csv"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>nep_585<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"ssp585"</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine in list</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>roms_avg_data <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">list</span>(nep_hind, nep_hist, nep_ssp126, nep_585))</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Add time and date information</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>roms_avg_data <span class="ot">&lt;-</span> roms_avg_data <span class="sc">%&gt;%</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> lubridate<span class="sc">::</span><span class="fu">as_date</span>(date),</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(date),</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> lubridate<span class="sc">::</span><span class="fu">year</span>(date))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Example indices 1:</strong> monthly index of sea surface temperature across all spatial strata</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run bias correction for all variables </span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - rbinds bias-corrected projection to historical run</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - SSP126</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>ssp126_biascorrected <span class="ot">&lt;-</span> <span class="fu">delta_correction</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">hindcast =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"hindcast"</span>),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">historical =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"historical"</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">projection =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"ssp126"</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ref_yrs =</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">2014</span>, <span class="co"># Overlap years for historical and hindcast ROMS</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">lognormal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># - SSP585</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>ssp585_biascorrected <span class="ot">&lt;-</span> <span class="fu">delta_correction</span>(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">hindcast =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"hindcast"</span>),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">historical =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"historical"</span>),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">projection =</span> roms_avg_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"ssp585"</span>),</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">ref_yrs =</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">2014</span>, <span class="co"># Overlap years for historical and hindcast ROMS</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">lognormal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract variable of interest</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>goa_SST_ssp126 <span class="ot">&lt;-</span> ssp126_biascorrected <span class="sc">%&gt;%</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(varname <span class="sc">==</span> <span class="st">"temp"</span> <span class="sc">&amp;</span> depthclass <span class="sc">==</span> <span class="st">"Surface"</span> <span class="sc">&amp;</span> NMFS_AREA <span class="sc">==</span> <span class="st">"All"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simulation =</span> <span class="st">"ssp126"</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>goa_SST_ssp585 <span class="ot">&lt;-</span> ssp585_biascorrected <span class="sc">%&gt;%</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(varname <span class="sc">==</span> <span class="st">"temp"</span> <span class="sc">&amp;</span> depthclass <span class="sc">==</span> <span class="st">"Surface"</span> <span class="sc">&amp;</span> NMFS_AREA <span class="sc">==</span> <span class="st">"All"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simulation =</span> <span class="st">"ssp585"</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">rbind</span>(goa_SST_ssp126, goa_SST_ssp585), <span class="fu">aes</span>(date, value_dc)) <span class="sc">+</span> </span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>simulation) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"SST (celcius)"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Year-Month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ROMS-index-generation_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Example indices 2:</strong> seasonal sea surface temperature across all spatial strata</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Take monthlies and average from SSP126</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>seasonal_sst_ssp126 <span class="ot">&lt;-</span> goa_SST_ssp126 <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">season =</span> <span class="fu">case_when</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>) <span class="sc">~</span> <span class="st">"spring"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">11</span>,<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">2</span>) <span class="sc">~</span> <span class="st">"winter"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>) <span class="sc">~</span> <span class="st">"summer"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">10</span>) <span class="sc">~</span> <span class="st">"fall"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(NMFS_AREA, simulation, varname, year, season) <span class="sc">%&gt;%</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">value_dc =</span> <span class="fu">mean</span>(value_dc))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(seasonal_sst_ssp126, <span class="fu">aes</span>(year, value_dc, <span class="at">colour =</span> season)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"SST (celcius)"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Year"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ROMS-index-generation_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Example indices 3:</strong> Monthly sea surface temperature across 610 and 620 for SSP126 and SSP585</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract variables we want</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>goa_SST_ssp126 <span class="ot">&lt;-</span> ssp126_biascorrected <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(varname <span class="sc">==</span> <span class="st">"temp"</span> <span class="sc">&amp;</span> depthclass <span class="sc">==</span> <span class="st">"Surface"</span> <span class="sc">&amp;</span> NMFS_AREA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"610"</span>, <span class="st">"620"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simulation =</span> <span class="st">"ssp126"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">values_from =</span> <span class="fu">c</span>(value_dc, value), <span class="at">names_from =</span> NMFS_AREA) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value_dc_610_620 =</span> (value_dc_610 <span class="sc">*</span> <span class="dv">63986698621</span> <span class="sc">+</span> value_dc_620 <span class="sc">*</span> <span class="dv">69583703140</span>) <span class="sc">/</span> (<span class="dv">63986698621</span> <span class="sc">+</span> <span class="dv">69583703140</span>)) <span class="co"># Take area weighted mean</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>goa_SST_ssp585 <span class="ot">&lt;-</span> ssp585_biascorrected <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(varname <span class="sc">==</span> <span class="st">"temp"</span> <span class="sc">&amp;</span> depthclass <span class="sc">==</span> <span class="st">"Surface"</span> <span class="sc">&amp;</span> NMFS_AREA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"610"</span>, <span class="st">"620"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simulation =</span> <span class="st">"ssp585"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">values_from =</span> <span class="fu">c</span>(value_dc, value), <span class="at">names_from =</span> NMFS_AREA) <span class="sc">%&gt;%</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value_dc_610_620 =</span> (value_dc_610 <span class="sc">*</span> <span class="dv">63986698621</span> <span class="sc">+</span> value_dc_620 <span class="sc">*</span> <span class="dv">69583703140</span>) <span class="sc">/</span> (<span class="dv">63986698621</span> <span class="sc">+</span> <span class="dv">69583703140</span>)) <span class="co"># Take area weighted mean</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>goa_SST_610_620 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(goa_SST_ssp126, goa_SST_ssp585)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(goa_SST_610_620, <span class="fu">aes</span>(year, value_dc_610_620, <span class="at">colour =</span> simulation)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"SST (Celcius)"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Year"</span>) <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>simulation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ROMS-index-generation_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Example index 4:</strong> mean monthly seasonal small copepod biomass spatial strata 610 and 620 for SSP585 across the water colum</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data averaged across depth and strata</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>nep_hind <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_indices/nep_sum_hind.csv"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>nep_hind<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"hindcast"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>nep_hist <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_indices/nep_sum_wb_hist.csv"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>nep_hist<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"historical"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>nep_ssp126 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_indices/nep_sum_wb_ssp126.csv"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>nep_ssp126<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"ssp126"</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>nep_585 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Data/NEP_10k_indices/nep_sum_wb_ssp585.csv"</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>nep_585<span class="sc">$</span>simulation <span class="ot">=</span> <span class="st">"ssp585"</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine in list</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>roms_sum_data <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">list</span>(nep_hind, nep_hist, nep_ssp126, nep_585))</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Add time and date information</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>roms_sum_data <span class="ot">&lt;-</span> roms_sum_data <span class="sc">%&gt;%</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> lubridate<span class="sc">::</span><span class="fu">as_date</span>(date),</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(date),</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> lubridate<span class="sc">::</span><span class="fu">year</span>(date))</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Run bias correction for all variables </span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co"># - rbinds bias-corrected projection to historical run</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co"># - SSP126</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>ssp126_sum_biascorrected <span class="ot">&lt;-</span> <span class="fu">delta_correction</span>(</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">hindcast =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"hindcast"</span>),</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">historical =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"historical"</span>),</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">projection =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"ssp126"</span>),</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">ref_yrs =</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">2014</span>, <span class="co"># Overlap years for historical and hindcast ROMS</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">lognormal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># - SSP585</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>ssp585_sum_biascorrected <span class="ot">&lt;-</span> <span class="fu">delta_correction</span>(</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">hindcast =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"hindcast"</span>),</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">historical =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"historical"</span>),</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">projection =</span> roms_sum_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(simulation <span class="sc">==</span> <span class="st">"ssp585"</span>),</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">ref_yrs =</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">2014</span>, <span class="co"># Overlap years for historical and hindcast ROMS</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">lognormal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract small copepod for desired area</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>goa_cop_ssp585 <span class="ot">&lt;-</span> ssp585_sum_biascorrected <span class="sc">%&gt;%</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(varname <span class="sc">==</span> <span class="st">"Cop"</span> <span class="sc">&amp;</span> depthclass <span class="sc">==</span> <span class="st">"All"</span> <span class="sc">&amp;</span> NMFS_AREA <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">610</span>, <span class="dv">620</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simulation =</span> <span class="st">"ssp585"</span>)</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to biomass</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="co"># - Units of Cop are mg C m^-2 of water column</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a><span class="co"># - Area is in m^2</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="co"># - Final units will be tonne 1e-9 tonnes in a gram</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>goa_cop_ssp585 <span class="ot">&lt;-</span> goa_cop_ssp585 <span class="sc">%&gt;%</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Cop_biom =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    NMFS_AREA <span class="sc">==</span> <span class="st">"610"</span> <span class="sc">~</span> <span class="dv">63986698621</span> <span class="sc">*</span> value <span class="sc">*</span> <span class="fl">1e-9</span>,</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="co"># 610 area = 63986698621 m^2</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    NMFS_AREA <span class="sc">==</span> <span class="st">"620"</span> <span class="sc">~</span> <span class="dv">69583703140</span> <span class="sc">*</span> value <span class="sc">*</span> <span class="fl">1e-9</span> <span class="co"># 620 area = 69583703140 m^2</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Take mean fall </span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>goa_cop_ssp585 <span class="ot">&lt;-</span> goa_cop_ssp585 <span class="sc">%&gt;%</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, month) <span class="sc">%&gt;%</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Cop_biom =</span> <span class="fu">sum</span>(Cop_biom)) <span class="sc">%&gt;%</span> <span class="co"># Sum biomass across 610 and 620</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">season =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>) <span class="sc">~</span> <span class="st">"spring"</span>,</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">11</span>,<span class="dv">12</span>,<span class="dv">1</span>,<span class="dv">2</span>) <span class="sc">~</span> <span class="st">"winter"</span>,</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>) <span class="sc">~</span> <span class="st">"summer"</span>,</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>    month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">10</span>) <span class="sc">~</span> <span class="st">"fall"</span>,</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, season) <span class="sc">%&gt;%</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Cop_biom =</span> <span class="fu">mean</span>(Cop_biom)) <span class="co"># Average across months per season</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(goa_cop_ssp585, <span class="fu">aes</span>(year, Cop_biom, <span class="at">colour =</span> season)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cop biomass (tonnes)"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Year"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="ROMS-index-generation_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>